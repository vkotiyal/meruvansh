// Prisma Schema for MeruVansh Family Tree Platform
// Database: PostgreSQL (Neon.tech)
// ORM: Prisma 6.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Model - Authentication & Account Management
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String // Hashed with bcrypt
  name          String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tree Tree?

  @@map("users")
  @@index([email])
}

// ============================================================================
// Tree Model - Family Tree Container
// ============================================================================

model Tree {
  id        String   @id @default(cuid())
  name      String
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodes          Node[]
  viewerAccesses ViewerAccess[]

  @@map("trees")
  @@index([userId])
}

// ============================================================================
// Node Model - Family Tree Members (with recursive parent-child and spouse)
// ============================================================================

model Node {
  id        String   @id @default(cuid())
  treeId    String
  parentId  String? // NULL for root nodes
  spouseId  String?  @unique // Spouse relationship (bidirectional)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Personal Information
  name           String
  nickname       String?
  email          String?
  phone          String?
  birthDate      DateTime? @db.Date
  deathDate      DateTime? @db.Date
  gender         String? // "male", "female", "other"
  profilePicture String? // Cloudinary URL
  address        String?
  bio            String?   @db.Text

  // Relations
  tree     Tree   @relation(fields: [treeId], references: [id], onDelete: Cascade)
  parent   Node?  @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Node[] @relation("NodeHierarchy")
  spouse   Node?  @relation("Spouse", fields: [spouseId], references: [id], onDelete: SetNull)
  spouseOf Node?  @relation("Spouse")

  @@map("nodes")
  @@index([treeId])
  @@index([parentId])
  @@index([email])
  @@index([name])
}

// ============================================================================
// ViewerAccess Model - Shared Read-Only Access for Family Members
// ============================================================================

model ViewerAccess {
  id         String   @id @default(cuid())
  treeId     String
  familyCode String   @unique // Unique family code (e.g., "sharma2024")
  password   String // Hashed with bcrypt
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tree Tree @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@map("viewer_access")
  @@index([treeId])
  @@index([familyCode])
}
